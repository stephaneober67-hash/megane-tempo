<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Megane E-Tech - Tempo Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root { 
            --bleu: #007bff; --blanc: #f8f9fa; --rouge: #ff4757; 
            --dark: #2c3e50; --green: #2ecc71; --orange: #f39c12; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f2f5; padding: 15px; scroll-behavior: smooth; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* HEADER FIXED */
        .header { background: var(--dark); color: white; padding: 15px 25px; display: flex; align-items: center; gap: 20px; position: sticky; top: 0; z-index: 1000; }
        .car-icon { width: 45px; height: 45px; fill: #3498db; background: white; padding: 8px; border-radius: 50%; }
        .storage-warning { position: absolute; top: 2px; right: 25px; font-size: 0.6rem; color: #bdc3c7; }

        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .card { padding: 12px; border-radius: 10px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; transition: 0.3s; }
        .card.bleu { background: var(--bleu); }
        .card.blanc { background: #bdc3c7; color: #2c3e50; }
        .card.rouge { background: var(--rouge); }
        .card.total { background: #8e44ad; }
        .card .val { font-size: 1.3rem; font-weight: bold; }
        .card-tarifs { position: absolute; right: 10px; top: 10px; text-align: right; font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 4px; border-radius: 4px; }
        .filter-indicator { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; background: #f1c40f; color: #000; padding: 2px 5px; border-radius: 3px; display: none; margin-bottom: 5px; width: fit-content; }

        .tabs { display: flex; background: #eee; position: sticky; top: 75px; z-index: 999; }
        .tab { padding: 12px 20px; cursor: pointer; border: none; background: none; font-weight: bold; color: #666; }
        .tab.active { background: white; color: var(--dark); border-bottom: 3px solid var(--dark); }
        
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }

        .box { background: #ffffff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
        #form-container { background: #fff9db; border: 2px solid #f1c40f; }

        /* TABLEAU AVEC SCROLL INTERNE */
        .table-wrapper { max-height: 500px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 10; border-bottom: 2px solid #dee2e6; }
        th, td { padding: 10px; text-align: left; font-size: 0.85rem; border-bottom: 1px solid #eee; }
        
        .btn-action { border:none; background:none; cursor:pointer; font-weight:bold; padding: 5px 10px; border-radius: 4px; color: #ff4757; }
        .btn-edit { color: var(--orange); }

        /* BOUTON RETOUR HAUT */
        #scrollTopBtn {
            position: fixed; bottom: 20px; right: 20px; z-index: 99;
            background: var(--dark); color: white; border: none; padding: 12px;
            border-radius: 50%; cursor: pointer; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; align-items: flex-end; }
        input, select { padding: 7px; border: 1px solid #ccc; border-radius: 4px; width: 100%; font-size: 0.85rem; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .badge { padding: 3px 10px; border-radius: 15px; font-weight: 800; font-size: 0.7rem; color: white; }
        .badge-bleu { background: var(--bleu); }
        .badge-blanc { background: #ecf0f1; color: #2c3e50; border: 1px solid #bdc3c7; }
        .badge-rouge { background: var(--rouge); }
    </style>
</head>
<body>

<button id="scrollTopBtn" onclick="window.scrollTo(0,0)" title="Remonter en haut">‚Üë</button>

<div class="container">
    <div class="header">
        <span class="storage-warning">‚ö†Ô∏è Stockage local (Navigateur). Pensez √† exporter.</span>
        <svg class="car-icon" viewBox="0 0 24 24"><path d="M18.92 11c.08 0 .15.01.22.03C20.25 11.41 21 12.4 21 13.5V19c0 .55-.45 1-1 1h-1c-.55 0-1-.45-1-1v-1H6v1c0 .55-.45 1-1 1H4c-.55 0-1-.45-1-1v-5.5c0-1.1.75-2.09 1.86-2.47.07-.02.14-.03.22-.03L5.5 11l1.47-4.41C7.32 5.53 8.25 5 9.27 5h5.46c1.02 0 1.95.53 2.3 1.59L18.5 11h.42zM6.5 15c-.83 0-1.5.67-1.5 1.5S5.67 18 6.5 18s1.5-.67 1.5-1.5S7.33 15 6.5 15zm11 0c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zM15.5 7h-7l-1 3h9l-1-3z"/></svg>
        <div>
            <h1 style="font-size:1.2rem">MEGANE E-TECH</h1>
        </div>
        <div style="margin-left: auto; display: flex; gap: 8px;">
            <div style="text-align:center"><button class="btn" style="background:#34495e" onclick="exportJSON()">üíæ Export</button><span id="last-export-date" style="font-size:0.5rem; display:block"></span></div>
            <div style="text-align:center"><button class="btn" style="background:#34495e" onclick="document.getElementById('fileRestore').click()">üìÇ Import</button><span id="last-import-date" style="font-size:0.5rem; display:block"></span></div>
            <input type="file" id="fileRestore" style="display:none" accept=".json" onchange="importJSON(event)">
        </div>
    </div>

    <div class="summary-cards">
        <div class="card bleu" id="card-bleu">
            <div class="filter-indicator">P√©riode</div>
            <h3>Bleu</h3><div class="card-tarifs">0.13/0.16‚Ç¨</div>
            <div class="val" id="sum-bleu">0 kWh</div><small id="cost-bleu">0 ‚Ç¨</small>
        </div>
        <div class="card blanc" id="card-blanc">
            <div class="filter-indicator">P√©riode</div>
            <h3>Blanc</h3><div class="card-tarifs">0.15/0.19‚Ç¨</div>
            <div class="val" id="sum-blanc">0 kWh</div><small id="cost-blanc">0 ‚Ç¨</small>
        </div>
        <div class="card rouge" id="card-rouge">
            <div class="filter-indicator">P√©riode</div>
            <h3>Rouge</h3><div class="card-tarifs">0.16/0.76‚Ç¨</div>
            <div class="val" id="sum-rouge">0 kWh</div><small id="cost-rouge">0 ‚Ç¨</small>
        </div>
        <div class="card total" id="card-total">
            <div class="filter-indicator">P√©riode</div>
            <h3>TOTAL</h3><div class="val" id="sum-total">0 kWh</div><small id="cost-total">0 ‚Ç¨</small>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab(event, 'tab-data')">Historique</button>
        <button class="tab" onclick="switchTab(event, 'tab-charts')">Graphiques</button>
    </div>

    <div id="tab-data" class="tab-content active">
        <div class="box" style="background:#f1f3f5">
            <div class="form-grid">
                <div><label style="font-size:0.7rem; font-weight:bold">Du</label><input type="date" id="f-start"></div>
                <div><label style="font-size:0.7rem; font-weight:bold">Au</label><input type="date" id="f-end"></div>
                <button class="btn" style="background:var(--bleu)" onclick="applyFilter()">Filtrer les cartes</button>
                <button class="btn" style="background:#95a5a6" onclick="resetFilter()">Reset</button>
            </div>
        </div>

        <div class="box" id="form-container">
            <div class="form-grid">
                <div><label>Date</label><input type="date" id="in-date" onchange="checkTempoAPI()"><span id="tempo-status"></span></div>
                <div><label>Couleur</label><select id="in-tempo"><option>Bleu</option><option>Blanc</option><option>Rouge</option></select></div>
                <div><label>Type</label><select id="in-type"><option value="HC">HC</option><option value="HP">HP</option></select></div>
                <div><label>Dur√©e</label><input type="text" id="in-duration" placeholder="02:30"></div>
                <div><label>kWh</label><input type="number" id="in-kwh" step="0.01"></div>
                <button class="btn" id="main-btn" style="background:var(--dark)" onclick="saveEntry()">Enregistrer</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>Date</th><th>Couleur</th><th>Dur√©e</th><th>kWh</th><th>Co√ªt</th><th>Action</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-charts" class="tab-content">
        <div class="chart-container"><canvas id="chart-kwh"></canvas></div>
        <div class="chart-container"><canvas id="chart-cost"></canvas></div>
    </div>
</div>

<script>
    const TARIFS = { 'Bleu': { HC: 0.1296, HP: 0.1609 }, 'Blanc': { HC: 0.1485, HP: 0.1893 }, 'Rouge': { HC: 0.1568, HP: 0.7562 } };
    let dataStore = JSON.parse(localStorage.getItem('ev_data_v8') || '[]');
    let editIndex = -1;

    window.onscroll = function() {
        document.getElementById("scrollTopBtn").style.display = (window.pageYOffset > 300) ? "block" : "none";
    };

    window.onload = () => { 
        document.getElementById('in-date').valueAsDate = new Date();
        render(); 
    };

    async function checkTempoAPI() {
        const dateInput = document.getElementById('in-date').value;
        const status = document.getElementById('tempo-status');
        if (!dateInput) return;
        try {
            const response = await fetch(`https://www.api-couleur-tempo.fr/api/jourTempo/${dateInput}`);
            const json = await response.json();
            const codes = { 1: "Bleu", 2: "Blanc", 3: "Rouge" };
            if (json.codeJour) {
                document.getElementById('in-tempo').value = codes[json.codeJour];
                status.innerText = "‚úÖ " + codes[json.codeJour];
            }
        } catch (e) { status.innerText = ""; }
    }

    function render(filterData = null) {
        const displayData = filterData || dataStore;
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        
        let sums = { Bleu: 0, Blanc: 0, Rouge: 0, kwh: 0, cost: 0 };
        let costs = { Bleu: 0, Blanc: 0, Rouge: 0 };

        displayData.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((item, idx) => {
            sums[item.tempo] += item.kwh;
            costs[item.tempo] += item.cost;
            sums.kwh += item.kwh;
            sums.cost += item.cost;

            tbody.innerHTML += `
                <tr>
                    <td><b>${item.date}</b></td>
                    <td><span class="badge badge-${item.tempo.toLowerCase()}">${item.tempo} ${item.type}</span></td>
                    <td>${item.duration}</td>
                    <td><b>${item.kwh.toFixed(2)}</b></td>
                    <td>${item.cost.toFixed(2)} ‚Ç¨</td>
                    <td><button class="btn-action" onclick="deleteItem(${idx})">Suppr.</button></td>
                </tr>`;
        });

        const isFiltered = filterData !== null;
        document.querySelectorAll('.filter-indicator').forEach(el => el.style.display = isFiltered ? 'block' : 'none');

        ['Bleu', 'Blanc', 'Rouge'].forEach(c => {
            document.getElementById(`sum-${c.toLowerCase()}`).innerText = sums[c].toFixed(1) + " kWh";
            document.getElementById(`cost-${c.toLowerCase()}`).innerText = costs[c].toFixed(2) + " ‚Ç¨";
        });
        document.getElementById('sum-total').innerText = sums.kwh.toFixed(1) + " kWh";
        document.getElementById('cost-total').innerText = sums.cost.toFixed(2) + " ‚Ç¨";
    }

    function applyFilter() {
        const s = document.getElementById('f-start').value;
        const e = document.getElementById('f-end').value;
        if(!s || !e) return;
        const filtered = dataStore.filter(d => d.date >= s && d.date <= e);
        render(filtered);
    }

    function resetFilter() {
        document.getElementById('f-start').value = "";
        document.getElementById('f-end').value = "";
        render();
    }

    function saveEntry() {
        const entry = {
            date: document.getElementById('in-date').value,
            tempo: document.getElementById('in-tempo').value,
            type: document.getElementById('in-type').value,
            duration: document.getElementById('in-duration').value || "-",
            kwh: parseFloat(document.getElementById('in-kwh').value) || 0,
        };
        if(!entry.date || entry.kwh <= 0) return alert("Date et kWh requis");
        entry.cost = entry.kwh * TARIFS[entry.tempo][entry.type];
        dataStore.push(entry);
        localStorage.setItem('ev_data_v8', JSON.stringify(dataStore));
        render();
    }

    function deleteItem(idx) {
        if(confirm("Supprimer cette recharge ?")) {
            dataStore.splice(idx, 1);
            localStorage.setItem('ev_data_v8', JSON.stringify(dataStore));
            render();
        }
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(dataStore)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `sauvegarde_megane_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importJSON(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { 
            dataStore = JSON.parse(ev.target.result); 
            localStorage.setItem('ev_data_v8', JSON.stringify(dataStore));
            render(); 
        };
        reader.readAsText(e.target.files[0]);
    }

    function switchTab(evt, tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        evt.currentTarget.classList.add('active');
        if(tabId === 'tab-charts') initCharts();
    }
</script>
</body>
</html>
