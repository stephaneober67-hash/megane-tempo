<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Megane E-Tech - Tempo vs ES [V9.9.11]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root { 
            --bleu: #007bff; --blanc: #f8f9fa; --rouge: #ff4757; 
            --dark: #2c3e50; --green: #2ecc71; --orange: #f39c12; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        
        .header { background: var(--dark); color: white; padding: 20px 25px; display: flex; align-items: center; gap: 20px; }
        .car-icon { width: 55px; height: 55px; fill: #3498db; background: white; padding: 8px; border-radius: 50%; }
        .header-controls { margin-left: auto; display: flex; flex-direction: column; align-items: flex-end; }
        .save-mention { font-size: 0.75rem; color: #f1c40f; font-weight: bold; margin-bottom: 4px; }
        .sync-info { font-size: 0.65rem; color: #bdc3c7; }

        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .card { padding: 15px; border-radius: 10px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; cursor: pointer; transition: 0.2s; border: 2px solid transparent; }
        .card:hover { transform: translateY(-3px); filter: brightness(1.1); }
        .card.bleu { background: var(--bleu); }
        .card.blanc { background: #bdc3c7; color: #2c3e50; }
        .card.rouge { background: var(--rouge); }
        .card.total { background: #8e44ad; }
        .card .val { font-size: 1.4rem; font-weight: bold; margin-top: 5px; }
        
        .card-tarifs-grid { position: absolute; right: 10px; top: 10px; display: flex; gap: 10px; font-size: 0.6rem; text-align: right; line-height: 1.2; font-weight: bold; opacity: 0.9; }
        .tarif-col { display: flex; flex-direction: column; }
        
        .nb-charge { font-size: 0.7rem; font-weight: bold; margin-top: 5px; opacity: 0.8; text-transform: uppercase; }

        .badge-filter { 
            position: absolute; bottom: 10px; right: 10px; background: var(--orange); color: white; 
            font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; animation: blink 1s infinite; display: none;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .tabs { display: flex; background: #eee; }
        .tab { padding: 15px 25px; cursor: pointer; border: none; background: none; font-weight: bold; color: #666; }
        .tab.active { background: white; color: var(--dark); border-bottom: 3px solid var(--dark); }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        .box { background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        .box-import { background: #e8f4fd; border-left: 5px solid var(--bleu); }
        .box-saisie { background: #fff9db; border: 2px solid #f1c40f; }
        .box-stats { background: #f0f7ff; border-left: 5px solid var(--dark); }
        .box-title { font-size: 0.9rem; font-weight: bold; margin-bottom: 12px; color: var(--dark); text-transform: uppercase; display: block; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; align-items: flex-end; }
        label { font-size: 0.75rem; font-weight: bold; color: #444; margin-bottom: 3px; display: block; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; font-size: 0.85rem; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.85rem; color: white; }
        .btn-add { background: var(--dark); }
        .btn-csv { background: var(--green); margin-top: 10px; }
        .btn-save { background: #34495e; }
        .btn-edit { background: var(--orange); padding: 4px 8px; font-size: 0.7rem; margin-right: 5px; }
        .btn-delete { background: var(--rouge); padding: 4px 8px; font-size: 0.7rem; }
        .btn-reset-filters { background: var(--orange); display: none; margin-top: 10px; animation: blink 1.5s infinite; }

        .table-scroll { max-height: 500px; overflow-y: scroll; border: 1px solid #eee; border-radius: 8px; background: white; }
        table { width: 100%; border-collapse: collapse; }
        thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 10; border-bottom: 2px solid #dee2e6; }
        th, td { padding: 12px 10px; text-align: left; font-size: 0.85rem; border-bottom: 1px solid #eee; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.75rem; color: white; }
        .badge-bleu { background: var(--bleu); }
        .badge-blanc { background: #95a5a6; }
        .badge-rouge { background: var(--rouge); }

        .chart-filters { display: flex; flex-wrap: wrap; gap: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; align-items: center; }
        .year-selector { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .year-checkbox { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; font-weight: bold; cursor: pointer; }
        .year-checkbox input { width: auto; cursor: pointer; }
        .chart-wrapper { background: white; padding: 20px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 25px; height: 450px; }
        
        #btn-top { position: fixed; bottom: 20px; right: 20px; background: var(--dark); color: white; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: none; z-index: 100; font-size: 20px; }
        .hidden { display: none !important; }

        .es-config-panel { background: #fff3e0; border: 1px solid #ffb74d; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .es-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; }
        .es-color-block { background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px; border: 1px solid #ffcc80; }
        .es-color-block h4 { font-size: 0.8rem; margin-bottom: 8px; text-align: center; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 10px; }
        .stat-box { border: 1px solid #ddd; border-radius: 8px; padding: 15px; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed rgba(0,0,0,0.1); font-size: 0.9rem; }
        .stat-row:last-child { border-bottom: none; }
        .stat-val { font-weight: bold; color: var(--dark); }
        
        .confirm-msg { color: var(--green); font-size: 0.7rem; font-weight: bold; text-align: center; height: 15px; margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="container" id="top">
    <div class="header">
        <svg class="car-icon" viewBox="0 0 24 24"><path d="M18.92 11c.08 0 .15.01.22.03C20.25 11.41 21 12.4 21 13.5V19c0 .55-.45 1-1 1h-1c-.55 0-1-.45-1-1v-1H6v1c0 .55-.45 1-1 1H4c-.55 0-1-.45-1-1v-5.5c0-1.1.75-2.09 1.86-2.47.07-.02.14-.03.22-.03L5.5 11l1.47-4.41C7.32 5.53 8.25 5 9.27 5h5.46c1.02 0 1.95.53 2.3 1.59L18.5 11h.42z"/></svg>
        <div><h1 style="font-size: 1.4rem;">SUIVI MEGANE E-TECH <span style="font-size: 0.7rem; opacity: 0.6;">V9.9.11</span></h1></div>
        <div class="header-controls">
            <span class="save-mention">‚ö†Ô∏è Donn√©es stock√©es localement. Exportez pour sauvegarder.</span>
            <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                <button class="btn btn-save" onclick="toggleESPanel()">‚öôÔ∏è Config Tarifs ES</button>
                <button class="btn btn-save" onclick="exportJSON()">üíæ Exporter</button>
                <button class="btn btn-save" onclick="document.getElementById('fileRestore').click()">üìÇ Restaurer</button>
                <input type="file" id="fileRestore" class="hidden" accept=".json" onchange="importJSON(event)">
            </div>
            <div class="sync-info" id="last-export">Dernier export : Jamais</div>
            <div class="sync-info" id="last-import">Dernier import : Jamais</div>
        </div>
    </div>

    <div class="summary-cards">
        <div class="card bleu" onclick="filterTableByTempo('Bleu')">
            <div class="badge-filter" id="filter-Bleu">FILTRE ACTIF</div>
            <div class="card-tarifs-grid" id="tarifs-bleu"></div>
            <h3>Bleu</h3><div class="val" id="sum-bleu">0 kWh</div><small id="cost-bleu">0 ‚Ç¨</small><br><small id="cost-es-bleu" style="opacity:0.8; font-style:italic;">ES: 0 ‚Ç¨</small><div class="nb-charge" id="count-bleu">0 charge</div>
        </div>
        <div class="card blanc" onclick="filterTableByTempo('Blanc')">
            <div class="badge-filter" id="filter-Blanc">FILTRE ACTIF</div>
            <div class="card-tarifs-grid" id="tarifs-blanc"></div>
            <h3>Blanc</h3><div class="val" id="sum-blanc">0 kWh</div><small id="cost-blanc">0 ‚Ç¨</small><br><small id="cost-es-blanc" style="opacity:0.8; font-style:italic;">ES: 0 ‚Ç¨</small><div class="nb-charge" id="count-blanc">0 charge</div>
        </div>
        <div class="card rouge" onclick="filterTableByTempo('Rouge')">
            <div class="badge-filter" id="filter-Rouge">FILTRE ACTIF</div>
            <div class="card-tarifs-grid" id="tarifs-rouge"></div>
            <h3>Rouge</h3><div class="val" id="sum-rouge">0 kWh</div><small id="cost-rouge">0 ‚Ç¨</small><br><small id="cost-es-rouge" style="opacity:0.8; font-style:italic;">ES: 0 ‚Ç¨</small><div class="nb-charge" id="count-rouge">0 charge</div>
        </div>
        <div class="card total" onclick="resetAllFilters()">
            <h3>TOTAL</h3><div class="val" id="sum-total">0 kWh</div><small id="cost-total">0 ‚Ç¨</small><br><small id="cost-es-total" style="opacity:0.8; font-style:italic;">ES: 0 ‚Ç¨</small><div class="nb-charge" id="count-total">0 charge</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab(event, 'tab-data')">Saisie & Historique</button>
        <button class="tab" onclick="switchTab(event, 'tab-charts')">Graphiques Comparatifs</button>
        <button class="tab" onclick="switchTab(event, 'tab-stats')">Bilan & Moyennes</button>
    </div>

    <div id="tab-data" class="tab-content active">
        <div id="es-panel" class="box es-config-panel hidden">
            <span class="box-title">‚öôÔ∏è Configuration des tarifs √âlectricit√© de Strasbourg (ES)</span>
            <div style="margin-bottom: 15px;">
                <label>Ann√©e de validit√© (ex: 2025)</label>
                <input type="number" id="es-year" style="max-width: 150px;">
            </div>
            <div class="es-grid-container">
                <div class="es-color-block" style="border-top: 4px solid var(--bleu);">
                    <h4>BLEU</h4>
                    <label>HP ES</label><input type="number" id="es-bleu-hp" step="0.0001">
                    <label>HC ES</label><input type="number" id="es-bleu-hc" step="0.0001">
                </div>
                <div class="es-color-block" style="border-top: 4px solid #95a5a6;">
                    <h4>BLANC</h4>
                    <label>HP ES</label><input type="number" id="es-blanc-hp" step="0.0001">
                    <label>HC ES</label><input type="number" id="es-blanc-hc" step="0.0001">
                </div>
                <div class="es-color-block" style="border-top: 4px solid var(--rouge);">
                    <h4>ROUGE</h4>
                    <label>HP ES</label><input type="number" id="es-rouge-hp" step="0.0001">
                    <label>HC ES</label><input type="number" id="es-rouge-hc" step="0.0001">
                </div>
            </div>
            <button class="btn btn-add" style="margin-top: 15px; width: 100%;" id="btn-save-es" onclick="saveESTarif()">Enregistrer les tarifs ES pour cette ann√©e</button>
            <div id="es-list" style="margin-top: 10px; font-size: 0.8rem; border-top: 1px solid #ffb74d; padding-top: 10px;"></div>
        </div>

        <div class="box box-stats">
            <span class="box-title">üìÖ Statistiques par P√©riode</span>
            <div class="form-grid">
                <div><label>Date d√©but</label><input type="date" id="stats-start" onchange="calcPeriodStats()"></div>
                <div><label>Date fin</label><input type="date" id="stats-end" onchange="calcPeriodStats()"></div>
                <div style="grid-column: span 2; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ced4da;">
                    <span id="period-result" style="font-weight: bold; color: var(--dark); font-size: 0.85rem;">S√©lectionnez deux dates pour voir le d√©tail.</span>
                    <button class="btn btn-reset-filters" id="btn-reset-filters" onclick="resetAllFilters()">‚ùå ANNULER FILTRES</button>
                </div>
            </div>
        </div>

        <div class="box box-import">
            <span class="box-title">üì• Importer Renault (CSV)</span>
            <input type="file" id="csvFileInput" accept=".csv"><br>
            <button class="btn btn-csv" onclick="handleCsvFile()">‚ö° Analyser le fichier</button>
        </div>

        <span class="box-title" style="margin-left: 5px;">‚ö° Ajouter / modifier une charge manuelle</span>
        <div class="box box-saisie" id="form-container">
            <div class="form-grid">
                <div>
                    <label>Date</label>
                    <input type="date" id="in-date" onchange="checkTempoAPI()">
                    <div id="tempo-status" style="font-size:0.7rem; font-weight:bold; margin-top:3px; height:12px;"></div>
                </div>
                <div><label>Tempo</label><select id="in-tempo"><option>Bleu</option><option>Blanc</option><option>Rouge</option></select></div>
                <div><label>Type</label><select id="in-type"><option value="HC">HC</option><option value="HP">HP</option></select></div>
                <div><label>D√©but</label><input type="time" id="in-start"></div>
                <div><label>Dur√©e</label><input type="text" id="in-duration" placeholder="02:30"></div>
                <div><label>kWh</label><input type="number" id="in-kwh" step="0.01"></div>
                <div><label>Km</label><input type="number" id="in-km"></div>
                <div style="display: flex; flex-direction: column;">
                    <div id="save-confirm" class="confirm-msg"></div>
                    <button class="btn btn-add" id="main-btn" onclick="saveEntry()">Enregistrer</button>
                </div>
                <button class="btn btn-delete hidden" id="cancel-btn" onclick="resetForm()">Annuler</button>
            </div>
        </div>

        <div class="table-scroll">
            <table>
                <thead>
                    <tr><th>Date</th><th>Tempo</th><th>Heures</th><th>kWh</th><th>Km</th><th>Co√ªt Tempo</th><th>Actions</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-charts" class="tab-content">
        <div class="chart-filters">
            <div style="font-weight: bold; font-size: 0.9rem; color: var(--dark);">Comparer les ann√©es (Tempo vs ES) :</div>
            <div id="year-checkbox-container" class="year-selector"></div>
        </div>
        <div class="chart-wrapper"><canvas id="chart-kwh"></canvas></div>
        <div class="chart-wrapper"><canvas id="chart-count"></canvas></div>
        <div class="chart-wrapper"><canvas id="chart-cost"></canvas></div>
    </div>
    
    <div id="tab-stats" class="tab-content">
        <div class="box box-stats">
            <span class="box-title">üìä √âvolution du compteur Kilom√©trique</span>
            <div class="chart-wrapper" style="height: 350px;"><canvas id="chart-km-history"></canvas></div>
            
            <span class="box-title">üìà Bilans Annuels & Moyennes</span>
            <div id="stats-year-container" class="stats-grid"></div>
        </div>
    </div>
</div>

<button id="btn-top" onclick="window.scrollTo({top:0, behavior:'smooth'})">‚Üë</button>

<script>
    const TARIFS = { 'Bleu': { HC: 0.1296, HP: 0.1609 }, 'Blanc': { HC: 0.1485, HP: 0.1893 }, 'Rouge': { HC: 0.1568, HP: 0.7562 } };
    const MOIS_FR = ["Jan", "F√©v", "Mar", "Avr", "Mai", "Jui", "Jul", "Ao√ª", "Sep", "Oct", "Nov", "D√©c"];
    const COLORS = ['#f39c12', '#9b59b6', '#2ecc71', '#7f8c8d', '#e67e22', '#16a085'];
    
    let dataStore = JSON.parse(localStorage.getItem('ev_data_v9_4') || '[]');
    let esTarifs = JSON.parse(localStorage.getItem('es_tarifs') || '{}');
    let currentFilterColor = null; let editIndex = -1; 
    let chartKwh = null, chartCost = null, chartCount = null, chartKm = null;

    window.onload = () => {
        document.getElementById('in-date').valueAsDate = new Date();
        updateDisplayLastSync(); renderESTarifs(); checkTempoAPI(); renderAll();
    };

    function toggleESPanel() { document.getElementById('es-panel').classList.toggle('hidden'); }

    function saveESTarif() {
        const year = document.getElementById('es-year').value;
        if(!year) return alert("Saisir ann√©e");
        esTarifs[year] = {
            'Bleu': { HP: parseFloat(document.getElementById('es-bleu-hp').value) || 0, HC: parseFloat(document.getElementById('es-bleu-hc').value) || 0 },
            'Blanc': { HP: parseFloat(document.getElementById('es-blanc-hp').value) || 0, HC: parseFloat(document.getElementById('es-blanc-hc').value) || 0 },
            'Rouge': { HP: parseFloat(document.getElementById('es-rouge-hp').value) || 0, HC: parseFloat(document.getElementById('es-rouge-hc').value) || 0 }
        };
        localStorage.setItem('es_tarifs', JSON.stringify(esTarifs)); renderESTarifs(); renderAll(); alert("Ok");
    }

    function renderESTarifs() {
        const list = document.getElementById('es-list');
        list.innerHTML = "<strong>Tarifs ES :</strong><br>";
        for(let y in esTarifs) list.innerHTML += `${y} | <span style="color:orange;cursor:pointer" onclick="editESTarif('${y}')">Mod</span> - <span style="color:red;cursor:pointer" onclick="deleteESTarif('${y}')">Supp</span><br>`;
    }

    function editESTarif(y) {
        const t = esTarifs[y]; document.getElementById('es-year').value = y;
        document.getElementById('es-bleu-hp').value = t['Bleu'].HP; document.getElementById('es-bleu-hc').value = t['Bleu'].HC;
        document.getElementById('es-blanc-hp').value = t['Blanc'].HP; document.getElementById('es-blanc-hc').value = t['Blanc'].HC;
        document.getElementById('es-rouge-hp').value = t['Rouge'].HP; document.getElementById('es-rouge-hc').value = t['Rouge'].HC;
    }

    function deleteESTarif(y) { if(confirm("Supprimer ?")) { delete esTarifs[y]; localStorage.setItem('es_tarifs', JSON.stringify(esTarifs)); renderESTarifs(); renderAll(); } }

    function updateDisplayLastSync() {
        document.getElementById('last-export').innerText = "Export : " + (localStorage.getItem('last_exp') || "Jamais");
        document.getElementById('last-import').innerText = "Import : " + (localStorage.getItem('last_imp') || "Jamais");
    }

    window.onscroll = () => { document.getElementById('btn-top').style.display = window.scrollY > 300 ? 'block' : 'none'; };

    async function checkTempoAPI() {
        const d = document.getElementById('in-date').value;
        const statusDiv = document.getElementById('tempo-status');
        if(!d) return;
        try {
            const res = await fetch(`https://www.api-couleur-tempo.fr/api/jourTempo/${d}`);
            const json = await res.json();
            const codes = { 1: "Bleu", 2: "Blanc", 3: "Rouge" };
            if (json.codeJour) {
                const color = codes[json.codeJour];
                document.getElementById('in-tempo').value = color;
                statusDiv.innerText = "Jour " + color;
                statusDiv.style.color = color === "Bleu" ? "#007bff" : (color === "Rouge" ? "#ff4757" : "#7f8c8d");
            }
        } catch (e) { statusDiv.innerText = ""; }
    }

    function renderAll() {
        updateCards(); renderTable(); renderGlobalStats();
        const isFiltered = currentFilterColor || document.getElementById('stats-start').value;
        document.getElementById('btn-reset-filters').style.display = isFiltered ? 'inline-block' : 'none';
    }

    function updateCards() {
        const start = document.getElementById('stats-start').value, end = document.getElementById('stats-end').value;
        let source = dataStore;
        if(start && end) source = dataStore.filter(d => d.date >= start && d.date <= end);
        
        let s = { Bleu: 0, Blanc: 0, Rouge: 0, k: 0, c: 0, cES: 0 };
        let costES = { Bleu: 0, Blanc: 0, Rouge: 0 }; 
        let n = { Bleu: 0, Blanc: 0, Rouge: 0, total: 0 };

        source.forEach(d => {
            const y = d.date.substring(0,4);
            s[d.tempo] += d.kwh; 
            n[d.tempo]++; 
            n.total++; 
            s.k += d.kwh; 
            s.c += d.cost;
            if(esTarifs[y] && esTarifs[y][d.tempo]) {
                const amount = (d.kwh * esTarifs[y][d.tempo][d.type]);
                s.cES += amount;
                costES[d.tempo] += amount;
            }
        });

        ['Bleu','Blanc','Rouge'].forEach(c => {
            const slug = c.toLowerCase();
            document.getElementById(`sum-${slug}`).innerText = s[c].toFixed(1) + " kWh";
            document.getElementById(`cost-${slug}`).innerText = (source.filter(d=>d.tempo===c).reduce((a,b)=>a+b.cost,0)).toFixed(2) + " ‚Ç¨";
            document.getElementById(`cost-es-${slug}`).innerText = "ES: " + costES[c].toFixed(2) + " ‚Ç¨";
            document.getElementById(`count-${slug}`).innerText = n[c] + " charge(s)";
            let lastY = Object.keys(esTarifs).sort().pop();
            let esHC = (lastY && esTarifs[lastY][c]) ? esTarifs[lastY][c].HC : "---", esHP = (lastY && esTarifs[lastY][c]) ? esTarifs[lastY][c].HP : "---";
            document.getElementById(`tarifs-${slug}`).innerHTML = `<div class="tarif-col">TEMPO<br>${TARIFS[c].HC}/${TARIFS[c].HP}</div><div class="tarif-col">ES<br>${esHC}/${esHP}</div>`;
        });
        document.getElementById('sum-total').innerText = s.k.toFixed(1) + " kWh";
        document.getElementById('cost-total').innerText = s.c.toFixed(2) + " ‚Ç¨";
        document.getElementById('cost-es-total').innerText = "ES: " + s.cES.toFixed(2) + " ‚Ç¨";
        document.getElementById('count-total').innerText = n.total + " charge(s)";
    }

    function renderTable() {
        const tbody = document.getElementById('table-body'); tbody.innerHTML = "";
        const start = document.getElementById('stats-start').value, end = document.getElementById('stats-end').value;
        let displayData = [...dataStore];
        if(start && end) displayData = displayData.filter(d => d.date >= start && d.date <= end);
        if(currentFilterColor) displayData = displayData.filter(d => d.tempo === currentFilterColor);
        displayData.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((item) => {
            const realIdx = dataStore.indexOf(item);
            tbody.innerHTML += `<tr><td>${item.date}</td><td><span class="badge badge-${item.tempo.toLowerCase()}">${item.tempo} ${item.type}</span></td><td>${item.start}</td><td><b>${item.kwh.toFixed(1)}</b></td><td>${item.km || '-'}</td><td>${item.cost.toFixed(2)}‚Ç¨</td><td><button class="btn btn-edit" onclick="editItem(${realIdx})">Mod</button><button class="btn btn-delete" onclick="deleteItem(${realIdx})">X</button></td></tr>`;
        });
    }

    function renderGlobalStats() {
        const container = document.getElementById('stats-year-container');
        if(!container) return; container.innerHTML = "";
        const years = [...new Set(dataStore.map(d => d.date.substring(0,4)))].sort();
        
        const kmEntries = [...dataStore].filter(d => d.km !== null && d.km !== undefined && d.km !== "" && parseFloat(d.km) > 0).sort((a,b) => new Date(a.date) - new Date(b.date));
        if(chartKm) chartKm.destroy();
        if(kmEntries.length > 0) {
            const minKm = Math.min(...kmEntries.map(d => parseFloat(d.km)));
            chartKm = new Chart(document.getElementById('chart-km-history').getContext('2d'), {
                type: 'line',
                data: {
                    labels: kmEntries.map(d => d.date),
                    datasets: [{ label: 'Km Compteur', data: kmEntries.map(d => parseFloat(d.km)), borderColor: '#2c3e50', backgroundColor: 'rgba(44, 62, 80, 0.1)', fill: true, tension: 0.2, pointRadius: 6, pointBackgroundColor: '#2c3e50' }]
                },
                plugins: [ChartDataLabels],
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { min: Math.floor(minKm * 0.995) } },
                    plugins: { 
                        datalabels: { display: true, align: 'top', formatter: (v) => v + " km", font: { size: 10, weight: 'bold' }, color: '#2c3e50', backgroundColor: 'rgba(255,255,255,0.8)', borderRadius: 3, padding: 2 } 
                    }
                }
            });
        }

        const reversedYears = [...years].reverse();
        reversedYears.forEach(y => {
            const yearData = dataStore.filter(d => d.date.startsWith(y)).sort((a,b) => new Date(a.date) - new Date(b.date));
            const totalKwh = yearData.reduce((a,b) => a + b.kwh, 0);
            const totalCost = yearData.reduce((a,b) => a + b.cost, 0);
            let totalCostES = 0;
            yearData.forEach(d => { if(esTarifs[y] && esTarifs[y][d.tempo]) totalCostES += (d.kwh * esTarifs[y][d.tempo][d.type]); });
            const kmY = yearData.filter(d => d.km && parseFloat(d.km) > 0);
            let dist = 0, conso100 = "N/A";
            if(kmY.length >= 2) { dist = parseFloat(kmY[kmY.length - 1].km) - parseFloat(kmY[0].km); conso100 = dist > 0 ? ((totalKwh / dist) * 100).toFixed(1) + " kWh/100" : "N/A"; }
            const months = [...new Set(yearData.map(d => d.date.substring(5,7)))].length || 1;
            const yearColor = COLORS[years.indexOf(y) % COLORS.length];
            container.innerHTML += `<div class="stat-box" style="background-color: ${yearColor}15; border-color: ${yearColor}50;"><h3 style="border-bottom:2px solid ${yearColor}; color: ${yearColor}; margin-bottom:10px; padding-bottom:5px;">Ann√©e ${y}</h3><div class="stat-row"><span>√ânergie :</span><span class="stat-val">${totalKwh.toFixed(1)} kWh</span></div><div class="stat-row"><span>Co√ªt Tempo :</span><span class="stat-val">${totalCost.toFixed(2)} ‚Ç¨</span></div><div class="stat-row"><span>Co√ªt ES estim√© :</span><span class="stat-val" style="font-style:italic;">${totalCostES > 0 ? totalCostES.toFixed(2) + ' ‚Ç¨' : '---'}</span></div><div class="stat-row"><span>Distance :</span><span class="stat-val">${dist > 0 ? dist + ' km' : 'N/A'}</span></div><div class="stat-row" style="color:var(--green)"><span>Conso moy. :</span><span class="stat-val">${conso100}</span></div><div class="stat-row" style="margin-top:5px; padding-top:5px; border-top:1px solid rgba(0,0,0,0.1);"><span>Moyenne/mois :</span><span class="stat-val">${(totalCost/months).toFixed(2)} ‚Ç¨</span></div></div>`;
        });
    }

    function handleCsvFile() {
        const file = document.getElementById('csvFileInput').files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result; const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
            const sep = text.includes(';') ? ';' : ',';
            let hIdx = lines.findIndex(l => l.toUpperCase().includes("DATE") && l.toUpperCase().includes("KWH"));
            if(hIdx === -1) return;
            const head = lines[hIdx].split(sep).map(h => h.trim().toUpperCase());
            const iD = head.indexOf("DATE"), iT = head.indexOf("TEMPO"), iS = head.indexOf("D√âBUT"), iK = head.findIndex(h => h.includes("KWH")), iKm = head.findIndex(h => h.includes("KM"));
            lines.slice(hIdx+1).forEach(l => {
                const c = l.split(sep).map(x => x.trim().replace(/"/g, '')); if(!c[iD]) return;
                const rD = c[iD].split('/'); if(rD.length !== 3) return;
                const d = `${rD[2]}-${rD[1].padStart(2,'0')}-${rD[0].padStart(2,'0')}`;
                const kwh = parseFloat(c[iK].replace(',','.')) || 0; if(kwh <= 0) return;
                const t = (iT !== -1 && c[iT]) ? (c[iT].charAt(0).toUpperCase() + c[iT].slice(1).toLowerCase()) : "Bleu";
                const start = iS !== -1 ? c[iS] : "22:00", type = (start >= "06:00" && start < "22:00") ? "HP" : "HC";
                if(!dataStore.some(x => x.date === d && Math.abs(x.kwh - kwh) < 0.01)) { dataStore.push({ date: d, tempo: t, type, start, kwh, km: iKm !== -1 ? c[iKm] : "", cost: kwh * (TARIFS[t][type]), duration: "00:00" }); }
            });
            localStorage.setItem('ev_data_v9_4', JSON.stringify(dataStore)); renderAll();
        };
        reader.readAsText(file);
    }

    function saveEntry() {
        const date = document.getElementById('in-date').value, kwh = parseFloat(document.getElementById('in-kwh').value) || 0;
        const t = document.getElementById('in-tempo').value, ty = document.getElementById('in-type').value;
        const start = document.getElementById('in-start').value || "00:00", km = document.getElementById('in-km').value;
        const msgZone = document.getElementById('save-confirm');
        if(editIndex === -1 && dataStore.some(d => d.date === date && d.start === start && d.kwh === kwh)) return alert("‚ö†Ô∏è Doublon d√©tect√©.");
        const e = { date, tempo: t, type: ty, start, duration: document.getElementById('in-duration').value || "00:00", kwh, km, cost: kwh * TARIFS[t][ty] };
        if(editIndex > -1) { dataStore[editIndex] = e; msgZone.innerText = "‚úÖ Ligne modifi√©e !"; } else { dataStore.push(e); msgZone.innerText = "‚úÖ Ligne ajout√©e !"; }
        setTimeout(() => { msgZone.innerText = ""; }, 3000);
        localStorage.setItem('ev_data_v9_4', JSON.stringify(dataStore)); resetForm(); renderAll();
    }

    function editItem(idx) {
        editIndex = idx; const d = dataStore[idx];
        document.getElementById('in-date').value = d.date; document.getElementById('in-tempo').value = d.tempo;
        document.getElementById('in-type').value = d.type; document.getElementById('in-start').value = d.start;
        document.getElementById('in-kwh').value = d.kwh; document.getElementById('in-km').value = d.km;
        document.getElementById('main-btn').innerText = "MAJ"; document.getElementById('cancel-btn').classList.remove('hidden');
    }

    function resetForm() { editIndex = -1; document.getElementById('main-btn').innerText = "Enregistrer"; document.getElementById('cancel-btn').classList.add('hidden'); }
    function deleteItem(idx) { if(confirm("Supprimer ?")) { dataStore.splice(idx,1); localStorage.setItem('ev_data_v9_4', JSON.stringify(dataStore)); renderAll(); } }
    function filterTableByTempo(c) { currentFilterColor = c; renderAll(); }
    function resetAllFilters() { currentFilterColor = null; document.getElementById('stats-start').value = ""; document.getElementById('stats-end').value = ""; renderAll(); }
    function calcPeriodStats() { renderAll(); }

    function switchTab(evt, id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active'); evt.currentTarget.classList.add('active');
        if(id === 'tab-charts') initChartFilters();
        if(id === 'tab-stats') renderGlobalStats();
    }

    function initChartFilters() {
        const years = [...new Set(dataStore.map(d => d.date.substring(0,4)))].sort();
        const container = document.getElementById('year-checkbox-container'); if(!container) return;
        container.innerHTML = "";
        years.forEach((y, i) => { container.innerHTML += `<label class="year-checkbox"><input type="checkbox" value="${y}" ${i === years.length-1?'checked':''} onchange="updateCharts()"> ${y}</label>`; });
        updateCharts();
    }

    function updateCharts() {
        const selY = Array.from(document.querySelectorAll('#year-checkbox-container input:checked')).map(cb => cb.value);
        const allY = [...new Set(dataStore.map(d => d.date.substring(0,4)))].sort();
        if(selY.length === 0) return;
        const dsK = [], dsC = [], dsN = [];
        selY.forEach((y) => {
            let dK = Array(12).fill(0), dC = Array(12).fill(0), dES = Array(12).fill(0), dN = Array(12).fill(0);
            dataStore.filter(d => d.date.startsWith(y)).forEach(d => {
                let m = parseInt(d.date.substring(5,7)) - 1;
                dK[m] += d.kwh; dC[m] += d.cost; dN[m] += 1;
                if(esTarifs[y] && esTarifs[y][d.tempo]) dES[m] += (d.kwh * esTarifs[y][d.tempo][d.type]);
            });
            const color = COLORS[allY.indexOf(y) % COLORS.length];
            dsK.push({ label: `kWh ${y}`, data: dK, backgroundColor: color });
            dsN.push({ label: `Charges ${y}`, data: dN, borderColor: color, tension: 0.4 });
            dsC.push({ label: `Tempo ${y}`, data: dC, borderColor: color });
            if(esTarifs[y]) dsC.push({ label: `ES ${y}`, data: dES, borderColor: color, borderDash: [5, 5] });
        });
        if(chartKwh) chartKwh.destroy(); if(chartCount) chartCount.destroy(); if(chartCost) chartCost.destroy();
        const opt = (t) => ({ 
            responsive: true, maintainAspectRatio: false, 
            plugins: { 
                title: { display: true, text: t }, 
                datalabels: { 
                    display: true, align: 'top', font: { weight: 'bold' }, 
                    formatter: (v) => v > 0 ? Math.round(v) : ''
                } 
            } 
        });
        chartKwh = new Chart(document.getElementById('chart-kwh').getContext('2d'), { type:'bar', data:{labels:MOIS_FR, datasets:dsK}, plugins:[ChartDataLabels], options:opt('kWh / mois') });
        chartCount = new Chart(document.getElementById('chart-count').getContext('2d'), { type:'line', data:{labels:MOIS_FR, datasets:dsN}, plugins:[ChartDataLabels], options:opt('Charges / mois') });
        chartCost = new Chart(document.getElementById('chart-cost').getContext('2d'), { type:'line', data:{labels:MOIS_FR, datasets:dsC}, plugins:[ChartDataLabels], options:opt('Co√ªts Tempo vs ES (‚Ç¨)') });
    }

    function exportJSON() {
        const fullD = new Date().toLocaleString('fr-FR'); localStorage.setItem('last_exp', fullD);
        const obj = { data: dataStore, es: esTarifs, last_export: fullD, last_import: localStorage.getItem('last_imp') || "Jamais" };
        const blob = new Blob([JSON.stringify(obj)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `suivi-megane-complet.json`;
        a.click(); updateDisplayLastSync();
    }

    function importJSON(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const imp = JSON.parse(ev.target.result);
                if (imp.data) { dataStore = imp.data; esTarifs = imp.es || {}; } else { dataStore = imp; }
                localStorage.setItem('last_imp', new Date().toLocaleString('fr-FR'));
                localStorage.setItem('ev_data_v9_4', JSON.stringify(dataStore));
                localStorage.setItem('es_tarifs', JSON.stringify(esTarifs));
                updateDisplayLastSync(); renderESTarifs(); renderAll(); alert("Ok");
            } catch (err) { alert("Erreur"); }
        };
        reader.readAsText(e.target.files[0], 'UTF-8');
    }
</script>
</body>
</html>
